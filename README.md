# ì½˜ì„œíŠ¸ ì˜ˆì•½ ì„œë²„ (Concert Booking Server)

NestJSë¡œ êµ¬ì¶•ëœ ê³ ì„±ëŠ¥ ì½˜ì„œíŠ¸ ì˜ˆì•½ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ê°•ë ¥í•œ ë™ì‹œì„± ì œì–´ì™€ ìµœì í™”ëœ ë°ì´í„°ë² ì´ìŠ¤ ìš´ì˜ì´ íŠ¹ì§•ì…ë‹ˆë‹¤.

## ğŸ¯ ê°œìš”

ì´ ì„œë¹„ìŠ¤ëŠ” ë†’ì€ ë™ì‹œì„± í™˜ê²½ì—ì„œë„ ì•ˆì •ì ì¸ ì½˜ì„œíŠ¸ ì¢Œì„ ì˜ˆì•½ì„ ê´€ë¦¬í•˜ëŠ” ë° ì¤‘ì ì„ ë‘¡ë‹ˆë‹¤. íŠ¸ë˜í”½ ê¸‰ì¦ì„ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ëŒ€ê¸°ì—´ ê¸°ë°˜ í† í° ì‹œìŠ¤í…œ, ë°ì´í„° ì¼ê´€ì„±ì„ ìœ„í•œ Redis ë¶„ì‚° ë½, ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•´ ì •ë°€í•˜ê²Œ ìµœì í™”ëœ ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ë¥¼ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

## âœ¨ ì£¼ìš” ê¸°ëŠ¥

* **ëŒ€ê¸°ì—´ ê´€ë¦¬**: 1,000ëª… ì´ìƒì˜ ë™ì‹œ ì ‘ì†ìë¥¼ ì§€ì›í•˜ëŠ” í† í° ê¸°ë°˜ ëŒ€ê¸°ì—´ ì‹œìŠ¤í…œ
* **ì‹¤ì‹œê°„ ì¢Œì„ ì˜ˆì•½**: ë¶„ì‚° ë½ì„ í™œìš©í•œ ì›ìì (Atomic) ì¢Œì„ ì˜ˆì•½
* **í¬ì¸íŠ¸/ì”ì•¡ ì‹œìŠ¤í…œ**: ë™ì‹œì„± ì²˜ë¦¬ê°€ ë³´ì¥ëœ í¬ì¸íŠ¸ ì¶©ì „ ë° ì‚¬ìš© ê¸°ëŠ¥
* **ê²°ì œ ì²˜ë¦¬**: ì˜ˆì•½ ë§Œë£Œ ìë™ ì²˜ë¦¬ ì‹œìŠ¤í…œ
* **ì„±ëŠ¥ ìµœì í™”**: DB ì¸ë±ì‹±ì„ í†µí•´ ì¿¼ë¦¬ ì†ë„ 150ë°° í–¥ìƒ ë‹¬ì„±

## ğŸ—ï¸ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Client                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     NestJS Server                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ QueueFacade â”‚  â”‚Reservation  â”‚  â”‚   BalanceFacade     â”‚  â”‚
â”‚  â”‚             â”‚  â”‚   Facade    â”‚  â”‚                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                â”‚                     â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                          â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              Redis Distributed Lock Manager          â”‚    â”‚
â”‚  â”‚     (WaitLock & NoWaitLock Strategies)              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      PostgreSQL        â”‚   â”‚         Redis          â”‚
â”‚   (TypeORM Entities)   â”‚   â”‚  (Queue & Caching)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” ë™ì‹œì„± ì œì–´ (Concurrency Handling)

### Redis ë¶„ì‚° ë½ ì „ëµ

ìš´ì˜ ìš”êµ¬ ì‚¬í•­ì— ë”°ë¼ ë‘ ê°€ì§€ ì°¨ë³„í™”ëœ ë½ ì „ëµì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

**1. Wait Lock (ìˆœì°¨ ì²˜ë¦¬ ë°©ì‹)**

* **ì‚¬ìš© ì‚¬ë¡€**: ëŒ€ê¸°ì—´ í† í° ìƒì„±, í¬ì¸íŠ¸ ì”ì•¡ ì‘ì—…
* **íŠ¹ì§•**: ê³µì •í•œ ìˆœì„œì— ë”°ë¥¸ ìˆœì°¨ì  ì²˜ë¦¬ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤.
* í´ë¼ì´ì–¸íŠ¸ëŠ” Redis Sorted Setì„ ì‚¬ìš©í•˜ì—¬ ìì‹ ì˜ ì°¨ë¡€ë¥¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
* ì—„ê²©í•œ ìˆœì„œê°€ í•„ìš”í•œ ì‘ì—…ì— ì í•©í•©ë‹ˆë‹¤.

**2. No-Wait Lock (ì¦‰ì‹œ ê²°ì • ë°©ì‹)**

* **ì‚¬ìš© ì‚¬ë¡€**: ì¢Œì„ ì˜ˆì•½
* **íŠ¹ì§•**: ë½ì„ íšë“í•  ìˆ˜ ì—†ëŠ” ê²½ìš° ì¦‰ì‹œ ì‹¤íŒ¨ ì²˜ë¦¬í•©ë‹ˆë‹¤.
* ì¬ê³  ê¸°ë°˜ ì‘ì—…(ìˆ˜ëŸ‰ = 1)ì— ìµœì í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
* ë¶ˆí•„ìš”í•œ ë¦¬ì†ŒìŠ¤ ëŒ€ê¸° ì‹œê°„ì„ ë°©ì§€í•©ë‹ˆë‹¤.

### ëŒ€ê¸°ì—´ í† í° ì‹œìŠ¤í…œ

* ëŒ€ê¸° ìˆœë²ˆ ì •ë³´ê°€ í¬í•¨ëœ JWT ê¸°ë°˜ í† í° ì‚¬ìš©
* ì„¤ì • ê°€ëŠ¥í•œ ì²˜ë¦¬ëŸ‰ ì œí•œ (ì˜ˆ: 10ì´ˆë‹¹ 250ëª… ì…ì¥)
* í† í° ë§Œë£Œ ìë™ ì²˜ë¦¬
* Redisë¥¼ í™œìš©í•œ ì‹¤ì‹œê°„ ëŒ€ê¸° ìˆœë²ˆ ì¶”ì 

## âš¡ ì„±ëŠ¥ ìµœì í™”

### ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ì‹±

ì¿¼ë¦¬ ë¶„ì„ì„ í†µí•´ ë‹¤ìŒê³¼ ê°™ì€ ì„±ëŠ¥ í–¥ìƒì„ ì´ëŒì–´ëƒˆìŠµë‹ˆë‹¤.

| ì¿¼ë¦¬ íŒ¨í„´ | ìµœì í™” ì „ | ìµœì í™” í›„ | ê°œì„  íš¨ê³¼ |
| --- | --- | --- | --- |
| ì¢Œì„ ì¡°íšŒ (concert_id, status) | 26.82ms | 0.20ms | **134ë°° ë¹¨ë¼ì§** |
| ì½˜ì„œíŠ¸ ì¡°íšŒ (date) | 28.90ms | 0.20ms | **144ë°° ë¹¨ë¼ì§** |

**ì ìš©ëœ ì¸ë±ìŠ¤:**

* `idx_concert_status`: ì£¼ìš” ì¡°íšŒ íŒ¨í„´ ìµœì í™”
* ë¹ˆë²ˆí•œ ì•¡ì„¸ìŠ¤ íŒ¨í„´ì„ íƒ€ê²ŸíŒ…í•œ ë³µí•© ì¸ë±ìŠ¤(Compound Index) ì ìš©

### ìºì‹± ì „ëµ

* ì½ê¸° ì‘ì—…ì´ ë§ì€ ì½˜ì„œíŠ¸ ì •ë³´ì— ìºì‹± ì ìš©
* JWTë¥¼ í™œìš©í•œ ëŒ€ê¸°ì—´ í† í° ìºì‹± (Stateless ë°©ì‹)
* Redisë¥¼ ì „ëµì ìœ¼ë¡œ í™œìš©í•˜ì—¬ DB ë¶€í•˜ ê°ì†Œ

## ğŸ“š API ì—”ë“œí¬ì¸íŠ¸

### ëŒ€ê¸°ì—´ ê´€ë¦¬

* `POST /queue/token` - ëŒ€ê¸°ì—´ í† í° ìš”ì²­
* `GET /queue/status` - ëŒ€ê¸°ì—´ ìƒíƒœ í™•ì¸ (JWT í•„ìš”)

### ì˜ˆì•½

* `GET /reservations/:date` - ì˜ˆì•½ ê°€ëŠ¥ ì¢Œì„ ì¡°íšŒ
* `POST /reservations` - ì˜ˆì•½ ìƒì„±
* `POST /payment` - ê²°ì œ ì²˜ë¦¬

### ì”ì•¡ ê´€ë¦¬

* `POST /balance/charge` - ì”ì•¡ ì¶©ì „
* `POST /balance/use` - ì”ì•¡ ì‚¬ìš©

## ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ

* **Framework**: NestJS (íƒ€ì… ì•ˆì •ì„±, ëª¨ë“ˆí˜• ì•„í‚¤í…ì²˜)
* **Database**: PostgreSQL (ACID ì¤€ìˆ˜, ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì €ì¥ì†Œ)
* **ORM**: TypeORM (íƒ€ì… ì•ˆì •ì„±, ë§ˆì´ê·¸ë ˆì´ì…˜ ê´€ë¦¬)
* **Caching & Locking**: Redis (ê³ ì„±ëŠ¥, ë¶„ì‚° ì²˜ë¦¬ ê¸°ëŠ¥)
* **Authentication**: JWT (Stateless, í™•ì¥ ê°€ëŠ¥í•œ ì¸ì¦)
* **Containerization**: Docker (ì¬í˜„ ê°€ëŠ¥í•œ ë°°í¬ í™˜ê²½)
* **Testing**: Jest + Docker Containers (ì‹¤ì œ ì˜ì¡´ì„±ì„ í™œìš©í•œ í†µí•© í…ŒìŠ¤íŠ¸)

## ğŸš€ ì‹œì‘í•˜ê¸°

### ì‚¬ì „ ìš”êµ¬ì‚¬í•­

* Docker & Docker Compose
* Node.js 18 ì´ìƒ (ë¡œì»¬ ê°œë°œìš©)

### ë¹ ë¥¸ ì‹œì‘

```bash
git clone https://github.com/getBlackBadge/3rd-concert.git
cd 3rd-concert
docker compose up

```

## ğŸ§ª í…ŒìŠ¤íŠ¸

### ë™ì‹œì„± í†µí•© í…ŒìŠ¤íŠ¸

ë³¸ í”„ë¡œì íŠ¸ëŠ” ë™ì‹œì„± ì‘ì—…ì„ ê²€ì¦í•˜ëŠ” í¬ê´„ì ì¸ í†µí•© í…ŒìŠ¤íŠ¸ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.

* **QueueFacade**: 1,000ê°œì˜ ë™ì‹œ í† í° ìš”ì²­ ì‹œ ìœ ë‹ˆí¬í•œ ìˆœë²ˆ í• ë‹¹ ë° ì†ë„ ì œí•œ(250ëª…/10ì´ˆ) ê²€ì¦
* **BalanceFacade**: ì”ì•¡ 50í¬ì¸íŠ¸ ìƒíƒœì—ì„œ 70ê°œ ë™ì‹œ ìš”ì²­ ì‹œ 50ê°œ ì„±ê³µ, 20ê°œ ì‹¤íŒ¨ ê²€ì¦
* **ReservationFacade**: ì¢Œì„ í•˜ë‚˜ì— ëŒ€í•œ 10ê°œ ë™ì‹œ ì˜ˆì•½ ì‹œë„ ì¤‘ ë‹¨ 1ê°œë§Œ ì„±ê³µí•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ì‹¤íŒ¨í•¨ì„ í™•ì¸

---

## ğŸ“š ì¶”ê°€ ë¬¸ì„œ

ìƒì„¸í•œ ê¸°ìˆ  ë¬¸ì„œëŠ” [`docs/`](docs/) í´ë”ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì˜ˆ: ë™ì‹œì„± ë¶„ì„, Redis ë¶„ì‚° ë½ êµ¬í˜„, k6 ë¶€í•˜ í…ŒìŠ¤íŠ¸ ë“±)

| Document                                     | Description                                                                       |
| -------------------------------------------- | --------------------------------------------------------------------------------- |
| [docs/step9.md](docs/step9.md)               | Implementation details: Custom exceptions, filters, interceptors, Winston logging |
| [docs/step10-1.md](docs/step10-1.md)         | Concurrency integration tests for QueueFacade and BalanceFacade                   |
| [docs/step10-2.md](docs/step10-2.md)         | Chapter 2 retrospective: Learning NestJS from scratch                             |
| [docs/step11.md](docs/step11.md)             | Concurrency analysis: DB locks vs Redis distributed locks vs Kafka                |
| [docs/step12.md](docs/step12.md)             | RedisWaitLockManager implementation & integration tests                           |
| [docs/step13.md](docs/step13.md)             | Redis caching strategies and performance optimization                             |
| [docs/step14.md](docs/step14.md)             | QueueFacade integration test with 1000 concurrent users                           |
| [docs/step15.md](docs/step15.md)             | Database indexing: 134x-144x query speed improvement                              |
| [docs/step16.md](docs/step16.md)             | MSA architecture design: Event-driven services, Saga pattern                      |
| [docs/step19.md](docs/step19.md)             | Load testing: k6 tests with Grafana/InfluxDB visualization                        |
| [docs/step20.md](docs/step20.md)             | Performance analysis: Bottleneck identification and optimization strategies       |
| [docs/how-to-start.md](docs/how-to-start.md) | Quick start guide for local development                                           |
| [docs/README.md](docs/README.md)             | Business use case documentation (Korean)                                          |
