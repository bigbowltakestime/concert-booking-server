# 콘서트 예약 서버 (Concert Booking Server)

NestJS로 구축된 고성능 콘서트 예약 서비스입니다. 강력한 동시성 제어와 최적화된 데이터베이스 운영이 특징입니다.

## 🎯 개요

이 서비스는 높은 동시성 환경에서도 안정적인 콘서트 좌석 예약을 관리하는 데 중점을 둡니다. 트래픽 급증을 관리하기 위한 대기열 기반 토큰 시스템, 데이터 일관성을 위한 Redis 분산 락, 성능 향상을 위해 정밀하게 최적화된 데이터베이스 쿼리를 구현했습니다.

## ✨ 주요 기능

* **대기열 관리**: 1,000명 이상의 동시 접속자를 지원하는 토큰 기반 대기열 시스템
* **실시간 좌석 예약**: 분산 락을 활용한 원자적(Atomic) 좌석 예약
* **포인트/잔액 시스템**: 동시성 처리가 보장된 포인트 충전 및 사용 기능
* **결제 처리**: 예약 만료 자동 처리 시스템
* **성능 최적화**: DB 인덱싱을 통해 쿼리 속도 150배 향상 달성

## 🏗️ 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                        Client                               │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                     NestJS Server                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ QueueFacade │  │Reservation  │  │   BalanceFacade     │  │
│  │             │  │   Facade    │  │                     │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
│         │                │                     │             │
│         └────────────────┼─────────────────────┘             │
│                          ▼                                   │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              Redis Distributed Lock Manager          │    │
│  │     (WaitLock & NoWaitLock Strategies)              │    │
│  └────────────────────────┬────────────────────────────┘    │
└───────────────────────────┼──────────────────────────────────┘
                            │
              ┌─────────────┴─────────────┐
              ▼                           ▼
┌────────────────────────┐   ┌────────────────────────┐
│      PostgreSQL        │   │         Redis          │
│   (TypeORM Entities)   │   │  (Queue & Caching)     │
└────────────────────────┘   └────────────────────────┘
```

## 🔐 동시성 제어 (Concurrency Handling)

### Redis 분산 락 전략

운영 요구 사항에 따라 두 가지 차별화된 락 전략을 구현했습니다.

**1. Wait Lock (순차 처리 방식)**

* **사용 사례**: 대기열 토큰 생성, 포인트 잔액 작업
* **특징**: 공정한 순서에 따른 순차적 처리를 보장합니다.
* 클라이언트는 Redis Sorted Set을 사용하여 자신의 차례를 기다립니다.
* 엄격한 순서가 필요한 작업에 적합합니다.

**2. No-Wait Lock (즉시 결정 방식)**

* **사용 사례**: 좌석 예약
* **특징**: 락을 획득할 수 없는 경우 즉시 실패 처리합니다.
* 재고 기반 작업(수량 = 1)에 최적화되어 있습니다.
* 불필요한 리소스 대기 시간을 방지합니다.

### 대기열 토큰 시스템

* 대기 순번 정보가 포함된 JWT 기반 토큰 사용
* 설정 가능한 처리량 제한 (예: 10초당 250명 입장)
* 토큰 만료 자동 처리
* Redis를 활용한 실시간 대기 순번 추적

## ⚡ 성능 최적화

### 데이터베이스 인덱싱

쿼리 분석을 통해 다음과 같은 성능 향상을 이끌어냈습니다.

| 쿼리 패턴 | 최적화 전 | 최적화 후 | 개선 효과 |
| --- | --- | --- | --- |
| 좌석 조회 (concert_id, status) | 26.82ms | 0.20ms | **134배 빨라짐** |
| 콘서트 조회 (date) | 28.90ms | 0.20ms | **144배 빨라짐** |

**적용된 인덱스:**

* `idx_concert_status`: 주요 조회 패턴 최적화
* 빈번한 액세스 패턴을 타겟팅한 복합 인덱스(Compound Index) 적용

### 캐싱 전략

* 읽기 작업이 많은 콘서트 정보에 캐싱 적용
* JWT를 활용한 대기열 토큰 캐싱 (Stateless 방식)
* Redis를 전략적으로 활용하여 DB 부하 감소

## 📚 API 엔드포인트

### 대기열 관리

* `POST /queue/token` - 대기열 토큰 요청
* `GET /queue/status` - 대기열 상태 확인 (JWT 필요)

### 예약

* `GET /reservations/:date` - 예약 가능 좌석 조회
* `POST /reservations` - 예약 생성
* `POST /payment` - 결제 처리

### 잔액 관리

* `POST /balance/charge` - 잔액 충전
* `POST /balance/use` - 잔액 사용

## 🛠️ 기술 스택

* **Framework**: NestJS (타입 안정성, 모듈형 아키텍처)
* **Database**: PostgreSQL (ACID 준수, 신뢰할 수 있는 저장소)
* **ORM**: TypeORM (타입 안정성, 마이그레이션 관리)
* **Caching & Locking**: Redis (고성능, 분산 처리 기능)
* **Authentication**: JWT (Stateless, 확장 가능한 인증)
* **Containerization**: Docker (재현 가능한 배포 환경)
* **Testing**: Jest + Docker Containers (실제 의존성을 활용한 통합 테스트)

## 🚀 시작하기

### 사전 요구사항

* Docker & Docker Compose
* Node.js 18 이상 (로컬 개발용)

### 빠른 시작

```bash
git clone https://github.com/getBlackBadge/3rd-concert.git
cd 3rd-concert
docker compose up

```

## 🧪 테스트

### 동시성 통합 테스트

본 프로젝트는 동시성 작업을 검증하는 포괄적인 통합 테스트를 포함합니다.

* **QueueFacade**: 1,000개의 동시 토큰 요청 시 유니크한 순번 할당 및 속도 제한(250명/10초) 검증
* **BalanceFacade**: 잔액 50포인트 상태에서 70개 동시 요청 시 50개 성공, 20개 실패 검증
* **ReservationFacade**: 좌석 하나에 대한 10개 동시 예약 시도 중 단 1개만 성공하고 나머지는 실패함을 확인

---

## 📚 추가 문서

상세한 기술 문서는 [`docs/`](docs/) 폴더에서 확인하실 수 있습니다. (예: 동시성 분석, Redis 분산 락 구현, k6 부하 테스트 등)

| Document                                     | Description                                                                       |
| -------------------------------------------- | --------------------------------------------------------------------------------- |
| [docs/step9.md](docs/step9.md)               | 구현 상세: 커스텀 예외 처리, 필터, 인터셉터, Winston 로깅 적용 |
| [docs/step10-1.md](docs/step10-1.md)         | QueueFacade 및 BalanceFacade에 대한 동시성 통합 테스트 |
| [docs/step10-2.md](docs/step10-2.md)         | 2주차 회고: 기초부터 시작하는 NestJS 학습 과정 |
| [docs/step11.md](docs/step11.md)             | 동시성 제어 분석: DB 락 vs Redis 분산 락 vs Kafka 비교 |
| [docs/step12.md](docs/step12.md)             | RedisWaitLockManager 구현 및 통합 테스트 |
| [docs/step13.md](docs/step13.md)             | Redis 캐싱 전략 및 성능 최적화 |
| [docs/step14.md](docs/step14.md)             | 1000명 동시 접속자 환경에서의 QueueFacade 통합 테스트 |
| [docs/step15.md](docs/step15.md)             | 데이터베이스 인덱싱: 쿼리 속도 134배~144배 향상 결과 |
| [docs/step16.md](docs/step16.md)             |  MSA 아키텍처 설계: 이벤트 기반 서비스 및 Saga 패턴 |
| [docs/step19.md](docs/step19.md)             | 부하 테스트: k6를 이용한 테스트 및 Grafana/InfluxDB 시각화 |
| [docs/step20.md](docs/step20.md)             | 성능 분석: 병목 구간 확인 및 최적화 전략 |
| [docs/how-to-start.md](docs/how-to-start.md) | 로컬 개발 환경 구축을 위한 퀵 스타트 가이드 |


---


